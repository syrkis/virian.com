---
import Header from "../components/Header.astro";
import Layout from "../layouts/Layout.astro";
import Cover from "../components/Cover.astro";
import Post from "../components/Post.astro";

export async function getStaticPaths() {
    const posts = import.meta.glob("../pages/posts/*.typ", { eager: true });

    return Object.entries(posts).map(([path, post]: [string, any]) => {
        const slug = path.split("/").pop()?.replace(".typ", "");
        return {
            params: { slug },
            props: { post },
        };
    });
}

const { slug } = Astro.params;
const { post } = Astro.props;
const { frontmatter } = post;
---

<Layout>
    <Header />
    <div class="cover">
        <Cover src={frontmatter.cover} slug={frontmatter.slug} />
    </div>

    <Post server:defer {slug}>
        <div slot="fallback" class="skeleton-content">
            <div class="skeleton-line"></div>
            <div class="skeleton-line"></div>
            <div class="skeleton-line"></div>
        </div>
    </Post>
</Layout>

<style>
    .cover {
        padding: 10vh 0;
    }
    .skeleton-content {
        padding: 1rem;
        max-width: 1200px;
        margin: 0 auto;
    }
    .skeleton-line {
        height: 1rem;
        background: #eee;
        margin: 0.5rem 0;
        border-radius: 4px;
        animation: pulse 1.5s infinite;
    }
    .skeleton-line:nth-child(2) {
        width: 90%;
    }
    .skeleton-line:nth-child(3) {
        width: 75%;
    }
    @keyframes pulse {
        0% {
            opacity: 0.6;
        }
        50% {
            opacity: 1;
        }
        100% {
            opacity: 0.6;
        }
    }
</style>

<script>
    document.addEventListener("astro:page-load", () => {
        const path = window.location.pathname;
        if (path !== "/" && path !== "/code" && path !== "/text") {
            window.scrollTo({
                top: 200,
                left: 0,
                behavior: "instant",
            });
        }
    });
</script>
